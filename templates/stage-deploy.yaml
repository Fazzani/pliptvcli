parameters:
  vmImage: 'Ubuntu-16.04'
  environment: 'dev'

stages:
- stage: DeployPackage_${{parameters.environment}}
  jobs:
    # track deployments on the environment
    - deployment: DeployPackage
      pool:
        vmImage: ${{ parameters.vmImage }}
      strategy:
      matrix:
        Python37:
          python.version: '3.7'
      environment: ${{ parameters.environment }}
      strategy:
        # default deployment strategy
        runOnce:
          deploy:
            steps:
              - download: none
              - task: DownloadBuildArtifacts@0
                inputs:
                  buildType: current
                  downloadType: single
                  artifactName: xpl
                  downloadPath: '$(System.ArtifactsDirectory)'
              - task: UsePythonVersion@0
                inputs:
                  versionSpec: '$(python.version)'
                  targetType: 'inline'
              - task: TwineAuthenticate@1
                displayName: 'Twine Authenticate to ${{ parameters.environment }}'
                inputs:
                  pythonUploadServiceConnection: ${{ parameters.environment }}
              - script: |
                  python -m twine upload --verbose -r "${{ parameters.environment }}" --config-file $(PYPIRC_PATH) xpl/dist/*
                displayName: 'Publishing package to ${{ parameters.environment }}'